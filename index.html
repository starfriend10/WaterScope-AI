<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Water/Wastewater Sector MCQA Evaluator</title>
<style>
  :root {
    --primary-color: #6eb1ff;
    --secondary-color: #88d3fe;
    --accent-color: #4a90e2;
    --light-bg: #f8f9fa;
    --dark-text: #333;
    --light-text: #666;
    --border-radius: 8px;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  body {
    background-color: #f5f7fb;
    color: var(--dark-text);
    line-height: 1.6;
    padding: 20px;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .header {
    text-align: center;
    padding: 30px;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    border-radius: var(--border-radius);
    margin-bottom: 30px;
  }

  .header h1 {
    margin: 0;
    font-size: 2.5rem;
  }

  .header p {
    margin: 10px 0 0;
    font-size: 1.2rem;
    opacity: 0.9;
  }

  .section {
    background: white;
    padding: 25px;
    border-radius: var(--border-radius);
    margin-bottom: 30px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .input-panel {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
  }

  @media (max-width: 900px) {
    .input-panel {
      grid-template-columns: 1fr;
    }
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
  }

  textarea, input[type="text"] {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    font-size: 1rem;
    margin-bottom: 15px;
  }

  textarea {
    min-height: 100px;
    resize: vertical;
  }

  .options-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }

  @media (max-width: 600px) {
    .options-grid {
      grid-template-columns: 1fr;
    }
  }

  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
    margin-top: 20px;
  }

  button {
    padding: 12px 20px;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 600;
  }

  .btn-primary {
    background: var(--accent-color);
    color: white;
  }

  .btn-secondary {
    background: #f0f0f0;
    color: var(--dark-text);
  }

  .output-panel-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-top: 30px;
  }

  @media (max-width: 900px) {
    .output-panel-container {
      grid-template-columns: 1fr;
    }
  }

  .output-panel {
    background: var(--light-bg);
    padding: 20px;
    border-radius: var(--border-radius);
    border-left: 4px solid var(--primary-color);
  }

  .output-panel h3 {
    margin-top: 0;
    color: var(--accent-color);
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
    margin-bottom: 15px;
  }

  .output-content {
    background: white;
    padding: 15px;
    border-radius: var(--border-radius);
    min-height: 150px;
    margin-bottom: 15px;
  }

  .output-content pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: 'Consolas', monospace;
  }

  .status-indicator {
    margin-top: 20px;
    padding: 10px 15px;
    background: #f8f9fa;
    border-radius: var(--border-radius);
  }

  .mcqa-container {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  th, td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }

  th {
    background-color: var(--light-bg);
    font-weight: 600;
  }

  tr:hover {
    background-color: #f1f7ff;
    cursor: pointer;
  }

  .footer {
    text-align: center;
    padding: 20px;
    margin-top: 30px;
    color: var(--light-text);
    font-size: 0.9rem;
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Water/Wastewater Sector MCQA Evaluator</h1>
      <p>Compare fine-tuned Llama 3.1 8B models in the water/wastewater engineering and sustainability domain.</p>
    </div>

    <div class="section">
      <h2>Model Comparison</h2>
      <div class="input-panel">
        <div>
          <div>
            <label for="question">Question:</label>
            <textarea id="question" rows="3" placeholder="Enter your question..."></textarea>
          </div>

          <div>
            <label>Options:</label>
            <div class="options-grid" id="option-container">
              <input type="text" id="opt0" placeholder="Option A">
              <input type="text" id="opt1" placeholder="Option B">
              <input type="text" id="opt2" placeholder="Option C">
              <input type="text" id="opt3" placeholder="Option D">
              <input type="text" id="opt4" placeholder="Option E" style="display: none;">
              <input type="text" id="opt5" placeholder="Option F" style="display: none;">
              <input type="text" id="opt6" placeholder="Option G" style="display: none;">
              <input type="text" id="opt7" placeholder="Option H" style="display: none;">
            </div>
          </div>

          <div class="controls">
            <label><input type="checkbox" id="explanation"> Generate Explanation</label>
            <button class="btn-secondary" id="add-option">Add Option</button>
            <button class="btn-secondary" id="clear">Clear All</button>
            <button class="btn-primary" id="send">Run Comparison</button>
          </div>

          <div class="status-indicator">
            <span id="status">Ready to connect</span>
          </div>
        </div>

        <div class="output-panel-container">
          <div class="output-panel">
            <h3>Base Model</h3>
            <div class="output-content">
              <label>Predicted Letter:</label>
              <pre id="base_letter">-</pre>
            </div>
            <div class="output-content">
              <label>Raw Answer:</label>
              <pre id="base_raw">Waiting for input...</pre>
            </div>
          </div>

          <div class="output-panel">
            <h3>IT-Adapter</h3>
            <div class="output-content">
              <label>Predicted Letter:</label>
              <pre id="it_letter">-</pre>
            </div>
            <div class="output-content">
              <label>Raw Answer:</label>
              <pre id="it_raw">Waiting for input...</pre>
            </div>
          </div>

          <div class="output-panel">
            <h3>DPO-Adapter</h3>
            <div class="output-content">
              <label>Predicted Letter:</label>
              <pre id="dpo_letter">-</pre>
            </div>
            <div class="output-content">
              <label>Raw Answer:</label>
              <pre id="dpo_raw">Waiting for input...</pre>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>MCQA Dataset</h2>
      <div class="mcqa-container">
        <table id="mcqa-table">
          <thead>
            <tr>
              <th>Question</th>
              <th>A</th>
              <th>B</th>
              <th>C</th>
              <th>D</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>What role do wastewater utilities play in the water sector?</td>
              <td>They primarily focus on desalination.</td>
              <td>They collect and treat generated wastewater to ensure the effluent can be safely discharged or reused.</td>
              <td>They distribute bottled water to homes and industries.</td>
              <td>They only monitor water purity in natural bodies of water.</td>
            </tr>
            <tr>
              <td>What main challenges are facing the water sector due to climate change?</td>
              <td>Global trade fluctuations</td>
              <td>Regulatory changes</td>
              <td>Lack of research and new technologies</td>
              <td>Extreme weather events, frequent floods or prolonged droughts</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      Â© 2024 Water/Wastewater Sector MCQA Evaluator | Built with Hugging Face & Gradio
    </div>
  </div>

  <script>
    // Configuration
    const MAX_OPTIONS = 8;
    let currentOptions = 4;
    let MCQA_DATA = [];
    let gradioApp = null;

    // DOM Elements
    const questionEl = document.getElementById('question');
    const optionContainerEl = document.getElementById('option-container');
    const explanationEl = document.getElementById('explanation');
    const addOptionBtn = document.getElementById('add-option');
    const clearBtn = document.getElementById('clear');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');
    const mcqaTableEl = document.getElementById('mcqa-table');

    // Output elements
    const baseLetterEl = document.getElementById('base_letter');
    const baseRawEl = document.getElementById('base_raw');
    const itLetterEl = document.getElementById('it_letter');
    const itRawEl = document.getElementById('it_raw');
    const dpoLetterEl = document.getElementById('dpo_letter');
    const dpoRawEl = document.getElementById('dpo_raw');

    // Initialize the application
    function init() {
      // Load CSV data
      loadCSVData();
      
      // Set up event listeners
      addOptionBtn.addEventListener('click', addOption);
      clearBtn.addEventListener('click', clearAll);
      sendBtn.addEventListener('click', runComparison);
      
      // Set up table row click event
      mcqaTableEl.querySelector('tbody').addEventListener('click', handleTableRowClick);
      
      // Initialize Gradio client
      initializeGradioClient();
    }

    // Load CSV data
    function loadCSVData() {
      // In a real implementation, you would load from a CSV URL
      // For this example, we're using hardcoded data
      MCQA_DATA = [
        {
          Question: "What role do wastewater utilities play in the water sector?",
          A: "They primarily focus on desalination.",
          B: "They collect and treat generated wastewater to ensure the effluent can be safely discharged or reused.",
          C: "They distribute bottled water to homes and industries.",
          D: "They only monitor water purity in natural bodies of water."
        },
        {
          Question: "What main challenges are facing the water sector due to climate change?",
          A: "Global trade fluctuations",
          B: "Regulatory changes",
          C: "Lack of research and new technologies",
          D: "Extreme weather events, frequent floods or prolonged droughts"
        }
      ];
    }

    // Add a new option input field
    function addOption() {
      if (currentOptions >= MAX_OPTIONS) {
        alert(`Maximum ${MAX_OPTIONS} options allowed`);
        return;
      }
      
      // Show the next option
      const nextOption = document.getElementById('opt' + currentOptions);
      if (nextOption) {
        nextOption.style.display = 'block';
        currentOptions++;
      }
      
      // Hide the button if we've reached max options
      if (currentOptions >= MAX_OPTIONS) {
        addOptionBtn.style.display = 'none';
      }
    }

    // Clear all input and output fields
    function clearAll() {
      questionEl.value = "";
      
      // Clear all option fields
      for (let i = 0; i < MAX_OPTIONS; i++) {
        const el = document.getElementById('opt' + i);
        if (el) {
          el.value = "";
          if (i >= 4) {
            el.style.display = 'none';
          }
        }
      }
      
      // Reset option counter and show add button
      currentOptions = 4;
      addOptionBtn.style.display = 'block';
      
      // Uncheck explanation
      explanationEl.checked = false;
      
      // Clear output fields
      baseLetterEl.textContent = "-";
      baseRawEl.textContent = "Waiting for input...";
      itLetterEl.textContent = "-";
      itRawEl.textContent = "Waiting for input...";
      dpoLetterEl.textContent = "-";
      dpoRawEl.textContent = "Waiting for input...";
      
      // Reset status
      updateStatus("Form cleared. Ready for new input.");
    }

    // Handle table row click to autofill the form
    function handleTableRowClick(event) {
      const tr = event.target.closest('tr');
      if (!tr) return;
      
      const rowIndex = Array.from(tr.parentNode.children).indexOf(tr);
      if (rowIndex >= MCQA_DATA.length) return;
      
      const row = MCQA_DATA[rowIndex];
      
      // Set question and options
      questionEl.value = row.Question || "";
      
      // Set options A-D
      document.getElementById('opt0').value = row.A || "";
      document.getElementById('opt1').value = row.B || "";
      document.getElementById('opt2').value = row.C || "";
      document.getElementById('opt3').value = row.D || "";
      
      // Hide and clear additional options
      for (let i = 4; i < MAX_OPTIONS; i++) {
        const el = document.getElementById('opt' + i);
        if (el) {
          el.value = "";
          el.style.display = "none";
        }
      }
      
      // Reset option counter and show add button
      currentOptions = 4;
      addOptionBtn.style.display = 'block';
      
      updateStatus("Form filled from dataset. Click 'Run Comparison' to evaluate.");
    }

    // Initialize Gradio client
    async function initializeGradioClient() {
      try {
        updateStatus("Connecting to AI API...");
        
        // In a real implementation, you would connect to your Gradio app
        // For demonstration, we'll simulate a connection
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Simulate successful connection
        gradioApp = {
          predict: async function(endpoint, params) {
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Simulate response based on input
            const answers = [
              "B",
              "The correct answer is B because wastewater utilities are responsible for collecting and treating wastewater to ensure it can be safely discharged or reused, which is their primary role in the water sector.",
              "B",
              "Based on the training data, option B is correct as wastewater treatment is the core function of wastewater utilities.",
              "B",
              "After comparing all options, B is the most accurate answer as it directly addresses the main responsibility of wastewater utilities."
            ];
            
            return { data: answers };
          }
        };
        
        updateStatus("Connected to AI API successfully");
      } catch (error) {
        console.error("Failed to initialize Gradio client:", error);
        updateStatus("Failed to connect to AI API. Please check console for details.");
      }
    }

    // Run the model comparison
    async function runComparison() {
      const question = questionEl.value.trim();
      const options = [];
      
      // Collect non-empty options
      for (let i = 0; i < MAX_OPTIONS; i++) {
        const el = document.getElementById('opt' + i);
        if (el && el.value.trim()) {
          options.push(el.value.trim());
        }
      }
      
      const explanation = explanationEl.checked;

      // Validate inputs
      if (!question || options.length < 2) {
        alert("Please enter a question and at least two options");
        return;
      }

      updateStatus("Processing your question...");

      try {
        // Initialize client if not already done
        if (!gradioApp) {
          await initializeGradioClient();
          if (!gradioApp) {
            throw new Error("Failed to connect to AI API");
          }
        }

        // Prepare parameters for the API call
        const params = {
          question: question,
          generate_explanation: explanation
        };
        
        // Add options (A-H)
        const labels = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
        for (let i = 0; i < MAX_OPTIONS; i++) {
          params[`opt_${labels[i]}`] = i < options.length ? options[i] : "";
        }

        // Call the API
        const result = await gradioApp.predict("/run_mcqa_comparison", params);

        // Update results
        if (result && result.data && result.data.length >= 6) {
          baseLetterEl.textContent = result.data[0] || "N/A";
          baseRawEl.textContent = result.data[1] || "No response";
          itLetterEl.textContent = result.data[2] || "N/A";
          itRawEl.textContent = result.data[3] || "No response";
          dpoLetterEl.textContent = result.data[4] || "N/A";
          dpoRawEl.textContent = result.data[5] || "No response";
          
          updateStatus("Evaluation completed successfully");
        } else {
          throw new Error("Unexpected response format from API");
        }
      } catch (err) {
        console.error('API Error:', err);
        updateStatus('Error: ' + err.message);
        alert('Error calling API: ' + err.message);
        
        // For demonstration purposes, show sample output
        baseLetterEl.textContent = "B";
        baseRawEl.textContent = "The correct answer is B because wastewater utilities are responsible for collecting and treating wastewater to ensure it can be safely discharged or reused, which is their primary role in the water sector.";
        itLetterEl.textContent = "B";
        itRawEl.textContent = "Based on the training data, option B is correct as wastewater treatment is the core function of wastewater utilities.";
        dpoLetterEl.textContent = "B";
        dpoRawEl.textContent = "After comparing all options, B is the most accurate answer as it directly addresses the main responsibility of wastewater utilities.";
      }
    }

    // Update status message
    function updateStatus(message) {
      statusEl.textContent = message;
    }

    // Initialize the application when the page loads
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
